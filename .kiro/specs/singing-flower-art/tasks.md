# 実装計画: Singing Flower Art

## 概要

本実装計画は、ユーザーの歌声に反応してインタラクティブに花が成長・開花・散るビジュアルアートシステムを構築します。TypeScript、HTML5 Canvas API、Web Audio APIを使用し、段階的に機能を実装していきます。

## タスク

- [x] 1. プロジェクト構造とコア型定義のセットアップ
  - HTML、CSS、TypeScriptの基本ファイルを作成
  - コアインターフェース（GrowthState、Point、GrowthParameters等）を定義
  - Canvas要素とアプリケーションのエントリーポイントを設定
  - _要件: 9.1, 9.6_

- [x] 2. AudioAnalyzerの実装
  - [x] 2.1 AudioAnalyzerクラスの基本構造を実装
    - Web Audio APIを使用してマイクアクセスを取得
    - AudioContext、AnalyserNodeを初期化
    - _要件: 1.1, 1.2, 9.2_
  
  - [x] 2.2 音量と音高の計算ロジックを実装
    - FFTデータから音量（デシベル）を計算
    - 自己相関法またはFFTピーク検出で音高（Hz）を計算
    - _要件: 1.3, 1.4_
  
  - [x] 2.3 AudioAnalyzerのプロパティテストを作成
    - **プロパティ1: 音声データの継続的な取得**
    - **検証: 要件 1.2, 1.3, 1.4**
  
  - [x] 2.4 エラーハンドリングを実装
    - マイクアクセス拒否時のエラー処理
    - Web Audio API非サポート時のエラー処理
    - _要件: 9.4, 9.5_
  
  - [x] 2.5 AudioAnalyzerのユニットテストを作成
    - 初期化テスト
    - エラーケースのテスト

- [x] 3. StateMachineの実装
  - [x] 3.1 StateMachineクラスと状態遷移ロジックを実装
    - GrowthState列挙型を定義
    - 状態遷移条件を実装（音量閾値、成長進行度閾値）
    - _要件: 2.1, 2.4, 3.5, 4.13, 5.8, 6.9_
  
  - [x] 3.2 状態遷移のプロパティテストを作成
    - **プロパティ2: 音量による状態遷移**
    - **プロパティ3: 成長進行による状態遷移**
    - **検証: 要件 2.4, 3.5, 4.13, 5.8**
  
  - [x] 3.3 StateMachineのユニットテストを作成
    - 初期状態のテスト
    - 各状態遷移の具体例テスト

- [x] 4. GrowthControllerの実装
  - [x] 4.1 GrowthControllerクラスと成長パラメータ計算を実装
    - 音量に応じた成長速度の計算
    - 音高に応じた揺れ、色相、明度の計算
    - _要件: 3.2, 3.3, 3.4, 4.2, 4.4, 4.5, 4.6_
  
  - [x] 4.2 成長パラメータのプロパティテストを作成
    - **プロパティ4: 音量による成長速度の変化**
    - **プロパティ5: 音高による色の変化**
    - **プロパティ6: 音高変化による揺れ**
    - **検証: 要件 3.2, 3.3, 3.4, 4.2, 4.4, 4.5, 4.6**

- [x] 5. Rendererの基本構造と背景描画
  - [x] 5.1 Rendererクラスの基本構造を実装
    - Canvas初期化とリサイズ処理
    - アニメーションループの設定
    - _要件: 7.4, 9.1, 9.6, 10.1, 10.2_
  
  - [x] 5.2 背景描画を実装
    - 放射状グラデーション（中央ディープネイビー、外側ブラック）
    - 残像効果のための透明度設定
    - _要件: 7.1, 7.2_
  
  - [x] 5.3 背景とCanvas初期化のユニットテストを作成
    - 背景グラデーションの描画テスト
    - Canvas初期化テスト
    - ウィンドウリサイズテスト
  
  - [x] 5.4 レスポンシブデザインのプロパティテストを作成
    - **プロパティ18: ウィンドウサイズに応じたCanvas調整**
    - **検証: 要件 10.1, 10.3**

- [x] 6. チェックポイント - 基本構造の確認
  - 全てのテストが通ることを確認
  - ユーザーに質問があれば確認

- [x] 7. 種子状態の描画実装
  - [x] 7.1 種子の描画ロジックを実装
    - 画面中央下（高さの75%位置）に円を描画
    - 脈動アニメーション（周期的な拡大縮小）
    - _要件: 2.2, 2.3_
  
  - [x] 7.2 種子状態のプロパティテストを作成
    - **プロパティ7: 種子の脈動アニメーション**
    - **検証: 要件 2.3**
  
  - [x] 7.3 種子状態のユニットテストを作成
    - 種子位置のテスト（画面中央下）
    - 脈動の具体例テスト

- [x] 8. 芽状態の描画実装
  - [x] 8.1 芽の描画ロジックを実装
    - 種子位置から上方向への線の描画
    - 音量に応じた線の長さの増加
    - 音高に応じた色の変化と揺れ
    - _要件: 3.1, 3.2, 3.3, 3.4_
  
  - [x] 8.2 芽状態のユニットテストを作成
    - 芽の描画開始位置テスト
    - 色変化と揺れの具体例テスト

- [ ] 9. 茎と葉状態の描画実装
  - [x] 9.1 茎の描画ロジックを実装
    - 茎の継続的な成長
    - 音量に応じた成長速度
    - _要件: 4.1, 4.2_
  
  - [x] 9.2 葉のデータ構造と生成ロジックを実装
    - Leafインターフェースの実装
    - 音量に応じた葉の生成速度
    - 葉の初期位置と角度の設定
    - _要件: 4.3, 4.4_
  
  - [x] 9.3 葉の描画ロジックを実装（ベジェ曲線）
    - 3次ベジェ曲線で葉を描画
    - 音高に応じた制御点の調整（しなり）
    - 茎から先端へのグラデーション（濃い緑→明るい緑）
    - _要件: 4.7, 4.8, 4.9_
  
  - [x] 9.4 葉の揺れアニメーションを実装
    - アイドル時のゆっくりとした周期的な揺れ
    - 音高変化に応じた追加の揺れ
    - _要件: 4.6, 4.10_
  
  - [x] 9.5 葉脈の描画ロジックを実装
    - 音量閾値超過時の葉脈表示
    - 葉脈の明るさの減衰
    - _要件: 4.11, 4.12_
  
  - [ ]* 9.6 葉の描画に関するプロパティテストを作成
    - **プロパティ6-A: 葉のアイドル時の揺れ**
    - **プロパティ6-B: 音高による葉のしなり**
    - **プロパティ6-C: 音量による葉脈の表示**
    - **プロパティ6-D: 葉のグラデーション**
    - **検証: 要件 4.8, 4.9, 4.10, 4.11, 4.12**
  
  - [ ]* 9.7 茎と葉状態のユニットテストを作成
    - 茎の成長テスト
    - 葉の生成テスト
    - 葉脈の表示と減衰テスト

- [ ] 10. チェックポイント - 成長段階の確認
  - 全てのテストが通ることを確認
  - 種子→芽→茎と葉の遷移が正しく動作することを確認
  - ユーザーに質問があれば確認

- [x] 11. RoseCurveの実装
  - [x] 11.1 RoseCurveクラスとバラ曲線計算を実装
    - 極座標方程式 r = a * cos(k * θ) の実装
    - パラメータa、kの調整機能
    - 極座標から直交座標への変換
    - _要件: 8.1, 8.2, 8.3, 8.5_
  
  - [x] 11.2 音高に応じたk値の動的変化を実装
    - 高い声でk値を増やす（花びらが細かく増える）
    - 低い声でk値を減らす（大きくゆったりした花びら）
    - _要件: 8.4_
  
  - [x] 11.3 RoseCurveのプロパティテストを作成
    - **プロパティ11: バラ曲線の数学的正確性**
    - **プロパティ12: バラ曲線パラメータの調整可能性**
    - **プロパティ13: 極座標から直交座標への変換（ラウンドトリップ）**
    - **検証: 要件 8.1, 8.2, 8.3, 8.5**
  
  - [x] 11.4 RoseCurveのユニットテストを作成
    - 特定のa、k値での曲線生成テスト
    - 座標変換の具体例テスト

- [ ] 12. 開花状態の描画実装
  - [x] 12.1 花の描画ロジックを実装
    - RoseCurveを使用した花びらの描画
    - 茎と葉の継続表示
    - _要件: 5.1, 5.2_
  
  - [x] 12.2 音声に応じた花の変化を実装
    - 音量に応じた輝き（発光効果）
    - 音量に応じた花びらの細かい揺れ
    - 音高に応じたバラ曲線係数の変化
    - 音高に応じた色の変化（高い音で淡い色、低い音で深い色）
    - _要件: 5.3, 5.4, 5.5, 5.6_
  
  - [ ] 12.3 開花状態のプロパティテストを作成
    - **プロパティ8: 茎と葉の継続表示**
    - **プロパティ9: 音量による花の輝きと揺れ**
    - **プロパティ10: 音高によるバラ曲線係数の変化**
    - **検証: 要件 5.2, 5.3, 5.4, 5.5, 5.6**
  
  - [ ] 12.4 開花状態のユニットテストを作成
    - 花の描画開始テスト
    - 茎と葉の継続表示テスト
    - 色変化の具体例テスト

- [ ] 13. ParticleSystemの実装
  - [x] 13.1 ParticleSystemクラスの基本構造を実装
    - Particleインターフェースの定義
    - パーティクル生成ロジック（全描画要素をパーティクル化）
    - _要件: 6.1_
  
  - [x] 13.2 飛散段階の物理演算を実装
    - 音量に応じた初速度の設定
    - 音高に応じた移動方向の設定
    - 重力と速度に基づく位置更新
    - 透明度の減少
    - _要件: 6.2, 6.3, 6.4, 6.5_
  
  - [x] 13.3 収束段階のロジックを実装
    - 透明度閾値到達時の段階遷移
    - 種子位置への移動ベクトル計算
    - 距離に応じた速度増加
    - 全パーティクル到達判定
    - _要件: 6.6, 6.7, 6.8, 6.9_
  
  - [ ] 13.4 ParticleSystemのプロパティテストを作成
    - **プロパティ14: 音量によるパーティクル初速度**
    - **プロパティ15: 音高によるパーティクル移動方向**
    - **プロパティ16: パーティクルの物理演算（飛散段階）**
    - **プロパティ17: パーティクルの透明化（飛散段階）**
    - **プロパティ17-A: パーティクルの収束段階への遷移**
    - **プロパティ17-B: パーティクルの種子位置への収束**
    - **プロパティ17-C: 距離に応じた収束速度の増加**
    - **プロパティ17-D: 収束完了時の状態遷移**
    - **検証: 要件 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8, 6.9**
  
  - [ ] 13.5 ParticleSystemのユニットテストを作成
    - パーティクル生成テスト
    - 飛散段階の具体例テスト
    - 収束段階の具体例テスト
    - 段階遷移テスト

- [ ] 14. 散る状態の描画実装
  - [x] 14.1 パーティクルの描画ロジックを実装
    - 各パーティクルの描画
    - 残像効果の表現
    - _要件: 7.3_
  
  - [x] 14.2 散る状態から種子状態への遷移を実装
    - 全パーティクル到達時の状態遷移
    - 種子の脈動再開
    - _要件: 6.9, 6.10_
  
  - [ ] 14.3 散る状態のユニットテストを作成
    - パーティクル描画テスト
    - 状態遷移テスト

- [x] 15. チェックポイント - 全体統合の確認
  - 全てのテストが通ることを確認
  - 全ての成長段階（種子→芽→茎と葉→開花→散る→種子）が正しく動作することを確認
  - ユーザーに質問があれば確認

- [ ] 16. 統合とポリッシュ
  - [x] 16.1 全コンポーネントを統合
    - Applicationクラスでコンポーネントを統合
    - アニメーションループで全コンポーネントを更新
    - _要件: 9.6_
  
  - [ ] 16.2 エラーハンドリングとフォールバックモードを実装
    - マイクアクセス拒否時の静的アニメーションモード
    - エラーメッセージの表示
    - _要件: 9.4, 9.5_
  
  - [ ] 16.3 統合テストを作成
    - エンドツーエンドの動作テスト
    - エラーケースの統合テスト
  
  - [ ] 16.4 パフォーマンス最適化
    - 描画の最適化
    - メモリ使用量の確認

- [ ] 17. 最終チェックポイント
  - 全てのテストが通ることを確認
  - 全ての要件が満たされていることを確認
  - ユーザーに最終確認

## 注意事項

- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントで段階的な検証を行い、問題を早期に発見します
- プロパティテストは普遍的な正確性プロパティを検証します（最低100回の反復）
- ユニットテストは特定の例とエッジケースを検証します
- 全てのタスクが必須であり、包括的なテストカバレッジを提供します
