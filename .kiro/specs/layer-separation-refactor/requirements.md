# レイヤー分離リファクタリング - 要件定義

## 1. 概要

Rendererクラスを4層のレイヤーシステムにリファクタリングし、本体とグローエフェクトを分離する。これにより、将来の崩壊アニメーション実装時に、本体が消えればグローも自然に消えるようになる。

## 2. 現状の問題

- すべての描画がメインキャンバスに直接行われている
- グローエフェクトが各描画メソッド内で加算合成により実装されている
- 本体とグローが分離されていないため、独立して制御できない
- 描画メソッドが`this.p`を直接使用しているため、別のキャンバスに描画できない

## 3. ユーザーストーリー

### 3.1 レイヤー構成
**As a** 開発者  
**I want** 4層のレイヤーシステム  
**So that** 本体、グロー、背景、パーティクルを独立して制御できる

**受け入れ基準:**
- Background層：背景グラデーションと波紋を描画、常に表示
- Body層：茎・葉・花を描画、クリッピング可能
- Glow層：Body層をコピーしてぼかしたもの、本体が消えれば自動的に消える
- Particles層：パーティクルを描画、マスクを無視して自由に動ける

### 3.2 グローエフェクトの生成
**As a** 開発者  
**I want** グローをBody層から自動生成  
**So that** 本体が消えればグローも自然に消える

**受け入れ基準:**
- Body層の内容をGlow層にコピー
- Glow層にぼかしフィルターを適用
- パーティクル個別のグローではなく、本体全体のグローを生成

### 3.3 描画メソッドの汎用化
**As a** 開発者  
**I want** すべての描画メソッドが描画先キャンバスをパラメータとして受け取る  
**So that** 任意のキャンバス（メインまたはp5.Graphics）に描画できる

**受け入れ基準:**
- `drawSeed`、`drawSprout`、`drawBloom`、`drawLeaf`などすべての描画メソッドに`canvas`パラメータを追加
- `canvas`は`p5`または`p5.Graphics`型
- 既存の動作を維持しながらリファクタリング

### 3.4 レイヤー合成
**As a** 開発者  
**I want** render()メソッドで各レイヤーを正しい順序で合成  
**So that** 期待通りの視覚効果が得られる

**受け入れ基準:**
- 合成順序：Background → Glow（加算合成） → Body（通常合成） → Particles（通常合成）
- 各レイヤーは毎フレームクリアされる（Backgroundを除く）
- レイヤーサイズはウィンドウリサイズ時に自動調整

## 4. 技術的制約

- p5.jsとp5.Graphicsを使用
- p5.Graphicsには`ADD`、`BLEND`などの定数が定義されていない（メインp5インスタンスから取得）
- p5.Graphicsの`filter()`メソッドにシェーダー初期化の問題がある可能性
- 既存のテストを壊さないこと

## 5. 非機能要件

- パフォーマンス：60fpsを維持
- 互換性：既存の描画結果と視覚的に同等
- 保守性：コードの可読性を維持
